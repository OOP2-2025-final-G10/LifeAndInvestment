<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>人生ゲーム - プレイ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='base-style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="game-page">
    <div class="game-container">
        <div class="game-main">
            <div class="map-area box-border">
                <span class="map-label">マップ</span>
                <div class="board-overlay">
                    <div class="tooltip-wrapper square" style="top: 86%; left: 22%;">
                        <span class="tooltip">スタート（大学卒業・旅立ち）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 86%; left: 24%;">
                        <span class="tooltip">卒業旅行で散財する<br>（3万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 86%; left: 27%;">
                        <span class="tooltip">実家の手伝いをしてお小遣いをもらう<br>（1万円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 86%; left: 29.9%;">
                        <span class="tooltip">1人暮らし開始。家具をニトリで爆買い<br>（5万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 86%; left: 32.5%;">
                        <span class="tooltip">【給料日】<br>（給料をもらう）<br>（みんなフリーター）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 86%; left: 35.5%;">
                        <span class="tooltip"> アルバイトでミスをして弁償。<br>（10万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 86%; left: 38.3%;">
                        <span class="tooltip">商店街の福引で<br>「お米券」が当たる。<br>（5,000円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 86%; left: 41.3%;">
                        <span class="tooltip">風邪をひいて寝込む。<br>（1回休み）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 86%; left: 44.0%;">
                        <span class="tooltip">SNSで投稿がプチバズり。<br>（3万円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 86%; left: 47.0%;">
                        <span class="tooltip">スマホの画面を割る。<br>（修理代 2万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 85%; left: 49.7%;">
                        <span class="tooltip">友人の引越しを手伝う。<br>（お礼に 1万円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 85%; left: 52.7%;">
                        <span class="tooltip">深夜のテンションで<br>謎の健康器具を買う。<br>（3万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 85%; left: 55.5%;">
                        <span class="tooltip">コンビニスイーツにハマる。<br>（5,000円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 84%; left: 58.3%;">
                        <span class="tooltip">マッチングアプリに登録する。<br>（課金 1万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 84%; left: 61%;">
                        <span class="tooltip">【ストップ！就職マス】<br>ルーレットで職業決定。<br>（就職祝い 10万円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 83%; left: 64%;">
                        <span class="tooltip">初任給で親にプレゼント。<br>（3万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 82%; left: 66.5%;">
                        <span class="tooltip">同期と飲み会で意気投合。<br>（全員と握手）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 81%; left: 69%;">
                        <span class="tooltip">満員電車で靴が片方なくなる。<br>（靴代 1万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 79%; left: 71%;">
                        <span class="tooltip">資格試験に合格。<br>（報奨金 5万円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 76%; left: 71%;">
                        <span class="tooltip">【給料日】<br>（給料をもらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 73%; left: 69.5%;">
                        <span class="tooltip">週末にフェスへ行く。<br>（チケット代 2万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 72%; left: 67%;">
                        <span class="tooltip">迷い猫を保護して<br>飼い主に感謝される。<br>（謝礼 3万円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 71%; left: 64.5%;">
                        <span class="tooltip">寝坊して遅刻。<br>（罰金 1万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 70%; left: 61.8%;">
                        <span class="tooltip">ボーナスが出た！<br>（給料の半額をもらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 70%; left: 59.3%;">
                        <span class="tooltip">衝動的に高い自転車を買う。<br>（10万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 70%; left: 56.8%;">
                        <span class="tooltip">サイクリングで健康になる。<br>（3マス進む）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 70%; left: 54%;">
                        <span class="tooltip">自炊に失敗して結局外食。<br>（5,000円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 69%; left: 51.5%;">
                        <span class="tooltip">路上ライブで投げ銭をもらう。<br>（2,000円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 69%; left: 48.8%;">
                        <span class="tooltip">クレジットカードの請求額に驚愕。<br>（5万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 69%; left: 46%;">
                        <span class="tooltip">同窓会で昔の恋人に再会。<br>（サイコロ：偶数なら3万払う<br>奇数なら恋人ができる）</span>
                    </div>


                    <div class="tooltip-wrapper square" style="top: 68%; left: 43.5%;">
                        <span class="tooltip">【給料日】<br>（給料をもらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 68%; left: 41%;">
                        <span class="tooltip">車を購入する。<br>（ローン頭金 50万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 67%; left: 38.5%;">
                        <span class="tooltip">ドライブデートに行く。<br>（燃料・食事代 3万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 66%; left: 36%;">
                        <span class="tooltip">営業成績トップで表彰。<br>（金一封 30万円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 66%; left: 33.5%;">
                        <span class="tooltip">ストレスで暴飲暴食。<br>（2万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 65%; left: 31%;">
                        <span class="tooltip">友人の結婚式ラッシュ。<br>（ご祝儀 10万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 62%; left: 29.5%;">
                        <span class="tooltip">【ストップ！結婚マス】<br>結婚なら全員から<br>ご祝儀3万円ずつもらう</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 59%; left: 29.3%;">
                        <span class="tooltip">旅行でハワイへ。<br>（50万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 56%; left: 30.5%;">
                        <span class="tooltip">手料理が美味しい。<br>（元気が出て2マス進む）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 54%; left: 32.7%;">
                        <span class="tooltip">喧嘩して家出する。<br>（1回休み）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 53%; left: 35%;">
                        <span class="tooltip">【給料日】<br>（給料をもらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 52.5%; left: 37.5%;">
                        <span class="tooltip">子犬を飼い始める。<br>（ペット代 20万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 53%; left: 40.3%;">
                        <span class="tooltip">宝くじ（ミニロト）に当選！<br>（100万円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 53.5%; left: 43%;">
                        <span class="tooltip">親知らずを抜く。<br>（治療費 1万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 54%; left: 45.5%;">
                        <span class="tooltip">副業が軌道に乗る。<br>（臨時収入 20万円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 55%; left: 48.3%;">
                        <span class="tooltip">ネット詐欺にあいかける。<br>（ソフト代 1万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 55%; left: 51%;">
                        <span class="tooltip">近所の騒音トラブルに遭遇。<br>（引越し代 30万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 57%; left: 54%;">
                        <span class="tooltip">趣味のキャンプ道具を揃える。<br>（15万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 58%; left: 57%;">
                        <span class="tooltip">YouTuberデビュー。<br>（収益 5万円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 59%; left: 59.5%;">
                        <span class="tooltip">税金の支払い。<br>（前回の給料による）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 60%; left: 62%;">
                        <span class="tooltip">家庭菜園のトマトが豊作。<br>（5,000円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 62%; left: 64.5%;">
                        <span class="tooltip">子供が生まれる！<br>（出産祝い 100万円もらう）<br>※未婚は親戚に-3万</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 63%; left: 67.3%;">
                        <span class="tooltip">学資保険に加入する。<br>（5万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 64%; left: 70%;">
                        <span class="tooltip">【給料日】<br>（給料をもらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 65%; left: 72.5%;">
                        <span class="tooltip">ゴルフを始める。<br>（セット代 20万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 66%; left: 75.3%;">
                        <span class="tooltip">ホールインワン達成！<br>（祝い金等 30万円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 65.5%; left: 78%;">
                        <span class="tooltip">ぎっくり腰になる。<br>（1回休み）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 62%; left: 79.8%;">
                        <span class="tooltip">温泉旅行で湯治する。<br>（5万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 58%; left: 80.3%;">
                        <span class="tooltip">会社の業績悪化。<br>（次の給料まで半額）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 54.5%; left: 80.3%;">
                        <span class="tooltip">転職の誘い。<br>（5以上ならランクアップ<br>給料＋10万）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 51%; left: 79.8%;">
                        <span class="tooltip">洗濯機が壊れて水浸し。<br>（修理・賠償 15万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 48%; left: 79.3%;">
                        <span class="tooltip">実家の蔵から骨董品発見。<br>（鑑定額 50万円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 44.5%; left: 78%;">
                        <span class="tooltip">老後のために投資を始める。<br>（投資信託 10万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 41.8%; left: 76%;">
                        <span class="tooltip">台風で屋根が飛ぶ。<br>（修理 100万円払う）<br>※保険あれば免除</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 40%; left: 74%;">
                        <span class="tooltip">【給料日】<br>（給料をもらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 39%; left: 72%;">
                        <span class="tooltip">勤続10年リフレッシュ休暇。<br>（サイコロ×2マス進む）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 37%; left: 69.3%;">
                        <span class="tooltip">子供の教育費がかさむ。<br>（30万円払う ※子持ちのみ）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 37%; left: 66.5%;">
                        <span class="tooltip">子供がコンクールで優勝！<br>（10万円もらう ※子持ちのみ）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 36%; left: 63.8%;">
                        <span class="tooltip">地域の役員を押し付けられる。<br>（ストレスで1回休み）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 35%; left: 61%;">
                        <span class="tooltip">ふるさと納税の返礼品が届く。<br>（3万円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 35%; left: 58.5%;">
                        <span class="tooltip">高級腕時計を買ってドヤる。<br>（100万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 35%; left: 55.8%;">
                        <span class="tooltip">腕時計をなくす。<br>（悲しみで1回休み）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 35%; left: 53%;">
                        <span class="tooltip">人間ドックで再検査。<br>（検査費 5万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 35%; left: 50%;">
                        <span class="tooltip">【給料日】<br>（給料をもらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 31%; left: 50%;">
                        <span class="tooltip">健康のためにジムに通う。<br>（会費 10万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 29%; left: 48.5%;">
                        <span class="tooltip">マッチョになってモテ期到来。<br>（全員から5万円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 29%; left: 45.5%;">
                        <span class="tooltip">熟年離婚の危機。<br>（1が出たら慰謝料 500万円）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 29%; left: 43%;">
                        <span class="tooltip">ジムの通いすぎで怪我。<br>（治療費 5万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 33%; left: 42%;">
                        <span class="tooltip">危機を乗り越え絆が深まる。<br>（指輪代 100万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 39%; left: 50%;">
                        <span class="tooltip">会社で小さなミスが発覚。<br>（1回休む）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 41.5%; left: 50%;">
                        <span class="tooltip">会社の飲み会に参加。<br>（参加費 1万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 44%; left: 48.5%;">
                        <span class="tooltip">子供から親孝行を受ける。<br>（40万円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 44%; left: 46%;">
                        <span class="tooltip">車で事故してしまう。<br>（慰謝料 100万円払う）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 43%; left: 43.5%;">
                        <span class="tooltip">昔隠したへそくりを発見。<br>（5万円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 40%; left: 42%;">
                        <span class="tooltip">インフルエンザにかかる。<br>（1回休み）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 37%; left: 42%;">
                        <span class="tooltip">ビンゴ大会でビンゴ！。<br>（賞金 10万円もらう）</span>
                    </div>
                    <div class="tooltip-wrapper square" style="top: 35%; left: 42%;">
                        <span class="tooltip">会社が倒産！リストラ！<br>（退職金 50万円もらうが<br>フリーターになる）</span>
                    </div>
                </div>
                <div class="zoom-btns">
                    <button>+</button>
                    <button>-</button>
                </div>
            </div>

            <div class="bottom-area">
                <div class="roulette-container box-border">
                    <div class="roulette-wrapper">
                        <img id="roulette" src="{{ url_for('static', filename='roulette.png') }}" alt="roulette">
                        <div class="roulette-pointer"></div>
                    </div>
                    <button id="spinBtn" class="roulette-circle {% if not is_my_turn %}disabled{% endif %}" {% if not
                        is_my_turn %}disabled{% endif %} data-is-my-turn="{{ 1 if is_my_turn else 0 }}">
                        まわす
                    </button>

                </div>
                <div class="game-logo box-border">人生ゲーム</div>
            </div>
        </div>

        <aside class="info-sidebar box-border">
            <details open>
                <summary>ユーザー</summary>
                <ul id="userList"></ul>
            </details>
            <details>
                <summary>株式売買</summary>
                <p>購入、または売却したい銘柄と数量を指定してください。-1を入力すると買えるだけ購入、もしくは全株を売却できます。</p>
                <select id="stockName">
                    <option value="東葉電気">東葉電気</option>
                    <option value="Novasystems">Novasystems</option>
                    <option value="関東食品">関東食品</option>
                    <option value="南日本旅客鉄道">南日本旅客鉄道</option>
                    <option value="林不動産レジデンシャル">林不動産レジデンシャル</option>
                </select>
                <input type="number" id="stockAmount" value="1" min="-1">
                <button onclick="buyStock()">購入</button>
                <button onclick="sellStock()">売却</button>
                <div id="tradeResult"></div>

                <div class="box-border">
                    <h3>現在までの推移</h3>
                    <canvas id="stockChart" width="400" height="200"></canvas>
                </div>
            </details>

            <ul class="status-info" id="userInfo">
                <li>名前：<span id="stat-name">-</span></li>
                <li>・ ゴールまでの距離：<span id="stat-dist">-</span></li>
                <li>・ 職業：<span id="stat-job">-</span></li>
                <li>・ 所持金：<span id="stat-money">-</span></li>
                <li>・ 配偶者の有無：<span id="stat-spouse">-</span></li>
                <li>・ 子供の数：<span id="stat-kids">-</span></li>
                <li>・ 持ち株：<span id="stat-company">-</span></li>
            </ul>
        </aside>
    </div>

    <script id="users-data" type="application/json">{{ users|tojson }}</script>

    <script>
        const wheel = document.getElementById("roulette");
        const btn = document.getElementById("spinBtn");
        const userList = document.getElementById("userList");
        const statusItems = document.querySelectorAll(".status-info li");

        updateSpinButton(isMyTurn);

        btn.onclick = () => {
            if (isSpinning) return;

            isSpinning = true;
            updateSpinButton(false);

            const es = new EventSource("/roulette/stream");

            es.onmessage = (e) => {
                const angle = parseFloat(e.data);
                if (Number.isNaN(angle)) return;

                wheel.style.transform = `rotate(${angle}deg)`;
            };

            es.onerror = () => {
                // SSE終了 = 演出終了
                es.close();

                fetch("/api/roulette/result", { method: "POST" })
                    .then(res => res.json())
                    .then(data => {
                        console.log("進んだマス:", data.step);
                        syncCurrentUserStatus();
                    })
                    .finally(async () => {
                        isSpinning = false;
                        await syncCurrentDay();
                        loadStockChart();
                        syncTurn();
                    });

            };
        };

        // データの取得と初期化
        let myUserId = "{{ user.user_id if user else '' }}";
        let isSpinning = false;
        let currentViewingUserId = myUserId;
        function loadUsers() {
            fetch("/api/users")
                .then(res => res.json())
                .then(data => {
                    userList.innerHTML = "";
                    data.users.forEach(u => {
                        const li = document.createElement("li");
                        const uBtn = document.createElement("button");
                        uBtn.textContent = u.name;
                        uBtn.className = "user-link";
                        uBtn.onclick = () => loadUserStatus(u.id);
                        li.appendChild(uBtn);
                        userList.appendChild(li);
                    });
                }).catch(err => console.error("データ取得エラー:", err));
        }


        // 3秒ごとに同期
        setInterval(loadUsers, 3000);
        loadUsers();

        async function syncTurn() {
            const res = await fetch("/api/game_state");
            const state = await res.json();

            const nowMyTurn = state.turn_user_id === myUserId;
            updateSpinButton(nowMyTurn);
        }

        syncTurn();
        setInterval(syncTurn, 2000);

        function updateSpinButton(serverSaysMyTurn) {
            const enabled = serverSaysMyTurn && !isSpinning;
            btn.disabled = !enabled;
            btn.classList.toggle("disabled", !enabled);
        }

        updateSpinButton(isMyTurn);

        function loadUserStatus(userId) {
            currentViewingUserId = userId;
            fetch(`/api/user/${userId}`)
                .then(res => res.json())
                .then(user => renderUserStatus(user));
        }


        function renderUserStatus(user) {
            statusItems[1].textContent = `・ ゴールまでの距離：${user.spot_id}`;
            statusItems[0].textContent = `ユーザー：${user.name}`;
            statusItems[2].textContent = `・ 職業：${user.job?.name ?? "なし"}`;
            statusItems[3].textContent = `・ 所持金：${user.money}`;
            const holdings = user.holdings || {};

            if (Object.keys(holdings).length === 0) {
                statusItems[6].textContent = `・ 持ち株：なし`;
            } else {
                const list = Object.entries(holdings)
                    .map(([name, qty]) => `${name} ×${qty}`)
                    .join(" / ");
                statusItems[6].textContent = `・ 持ち株：${list}`;
            }
        }


        function syncCurrentUserStatus() {
            if (!currentViewingUserId) return;

            fetch(`/api/user/${currentViewingUserId}`)
                .then(res => res.json())
                .then(user => {
                    document.getElementById('stat-name').textContent = user.name;
                    document.getElementById('stat-dist').textContent = user.spot_id || "0";
                    document.getElementById('stat-job').textContent = user.job?.name ?? "なし";
                    document.getElementById('stat-money').textContent = user.money;
                });
        }

        // ルーレット回転処理
        btn.onclick = () => {
            if (isSpinning) return;
            isSpinning = true;
            const es = new EventSource("/roulette/stream");
            es.onmessage = (e) => {
                if (e.data.startsWith("RESULT")) {
                    es.close();
                    isSpinning = false;
                    return;
                }
                wheel.style.transform = `rotate(${parseFloat(e.data)}deg)`;
            };
        };

<<<<<<< HEAD
        window.addEventListener("load", () => {
            currentViewingUserId = myUserId;
            loadUserStatus(myUserId);
            syncCurrentDay();
            loadStockChart();
        });

        function buyStock() {
            const stock = document.getElementById("stockName").value;
            const amount = document.getElementById("stockAmount").value;

            fetch("/api/stock/buy", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    stock_name: stock,
                    amount: amount
                })
            })

                .then(res => res.json())
                .then(result => {
                    document.getElementById("tradeResult").textContent =
                        result.purchased
                            ? `購入成功：${result.symbol} ×${result.qty}`
                            : `失敗：${result.reason}`;
                    syncCurrentUserStatus();
                });
        }

        function sellStock() {
            const stock = document.getElementById("stockName").value;
            const amount = document.getElementById("stockAmount").value;

            fetch("/api/stock/sell", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    stock_name: stock,
                    amount: amount
                })
            })

                .then(res => res.json())
                .then(result => {
                    document.getElementById("tradeResult").textContent =
                        result.sold
                            ? `売却成功：${result.symbol} ×${result.qty}`
                            : `失敗：${result.reason}`;
                    syncCurrentUserStatus();
                });
        }

        const TOTAL_DAYS = 132;
        const PREVIOUS_DAYS = 50;
        const PAST_DAYS = 50;
        let stockChart = null;
        let selectedChartStock = "東葉電気";
        let xMin = 1;
        let xMax = TOTAL_DAYS;

        let currentDay = PREVIOUS_DAYS; // 初期値（ゲーム開始前の日数分）

        async function syncCurrentDay() {
            const res = await fetch(`/api/user/${myUserId}`);
            const user = await res.json();

            currentDay = user.spot_id + PREVIOUS_DAYS + 1;
        }


        document
            .getElementById("stockName")
            .addEventListener("change", e => {
                selectedChartStock = e.target.value;
                loadStockChart(); // 即再描画
            });

        function padPrices(prices) {
            const padded = Array(TOTAL_DAYS + PREVIOUS_DAYS).fill(null);
            prices.forEach((v, i) => {
                if (i < TOTAL_DAYS + PREVIOUS_DAYS) padded[i] = v;
            });
            return padded;
        }

        async function loadStockChart() {
            const res = await fetch("/api/stock/prices");
            const data = await res.json();

            const xMinDynamic = Math.max(1, currentDay - PAST_DAYS);
            const xMaxDynamic = currentDay;

            const ctx = document.getElementById("stockChart").getContext("2d");

            const labels = Array.from(
                { length: TOTAL_DAYS + PREVIOUS_DAYS },
                (_, i) => {
                    const day = i + 1;                // マス目（日数）
                    const diff = day - currentDay;    // 現在との差

                    if (diff === 0) return "今日";
                    if (diff < 0) return `${Math.abs(diff)}日前`;
                    return `${diff}日後`;
                }
            );


            const datasets = Object.entries(data.prices)
                .filter(([name]) =>
                    selectedChartStock === "ALL" || name === selectedChartStock
                )
                .map(([name, prices]) => ({
                    label: name,
                    data: padPrices(prices),
                    borderWidth: 2,
                    tension: 0.3,
                    spanGaps: true,
                    pointRadius: 2,
                    pointHoverRadius: 3
                }));


            if (stockChart) {
                stockChart.data.labels = labels;
                stockChart.data.datasets = datasets;
                stockChart.options.scales.x.min = xMinDynamic;
                stockChart.options.scales.x.max = xMaxDynamic;
                stockChart.update();
                return;
            }

            stockChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    animation: false,

                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const label = context.dataset.label || "";
                                    const value = context.parsed.y;

                                    if (value == null) return label;

                                    return `${label}: ¥${value.toFixed(2)}`;
                                }
                            }
                        }
                    },

                    scales: {
                        x: {
                            min: xMinDynamic,
                            max: xMaxDynamic,
                            title: {
                                display: true,
                                text: "日数(日目)"
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: "株価(￥)"
                            }
                        }
                    }
                }

            });
        }

        setInterval(loadStockChart, 2000);
        loadStockChart();
    </script>
</body>
</html>